{% extends "layout.html" %}

{% block content %}
<div class="exp-container">
    <div class="header-section">
        <h2>Exp 7: WebAuthn & Password Authentication</h2>
        <p>Comprehensive experiment combining traditional password auth with modern WebAuthn (FIDO2).</p>
        <div id="user-status" class="status-badge">Not Logged In</div>
        <button id="logout-btn" class="btn btn-sm" style="display: none;" onclick="logout()">Logout</button>
    </div>

    <!-- Section 1: Traditional Auth -->
    <div class="card" id="password-section">
        <h3>1. Traditional Authentication</h3>
        <p class="text-muted">Start by creating an account or logging in with a password.</p>
        <div class="form-group">
            <input type="text" id="username" placeholder="Username" class="form-control">
            <input type="password" id="password" placeholder="Password" class="form-control">
        </div>
        <div class="button-group">
            <button onclick="registerPassword()" class="btn">Register (Password)</button>
            <button onclick="loginPassword()" class="btn">Login (Password)</button>
        </div>
        <div id="password-msg" class="message"></div>
    </div>

    <!-- Section 2: WebAuthn Setup -->
    <div class="card" id="setup-section" style="opacity: 0.5; pointer-events: none;">
        <h3>2. Security Setup (WebAuthn)</h3>
        <p class="text-muted">Register a biometric authenticator or security key for this account.</p>
        <button onclick="registerWebAuthn()" class="btn btn-primary">Add Authenticator</button>
        <div id="setup-msg" class="message"></div>
    </div>

    <!-- Section 3: WebAuthn Login -->
    <div class="card">
        <h3>3. WebAuthn Login</h3>
        <p class="text-muted">Login using your registered authenticator.</p>
        <div class="form-group">
            <input type="text" id="login-username" placeholder="Username" class="form-control">
        </div>
        <button onclick="loginWebAuthn()" class="btn btn-primary">Login with Passkey/biometrics</button>
        <div id="login-msg" class="message"></div>
    </div>
</div>

<style>
    .exp-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .header-section {
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .status-badge {
        background: #eee;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
    }

    .card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .form-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-control {
        flex: 1;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    .button-group {
        display: flex;
        gap: 1rem;
    }

    .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: #007bff;
        color: white;
        transition: background 0.2s;
    }

    .btn:hover {
        background: #0056b3;
    }

    .btn-sm {
        padding: 0.4rem 1rem;
        font-size: 0.9rem;
        background: #dc3545;
    }

    .text-muted {
        color: #666;
        margin-bottom: 1rem;
    }

    .message {
        margin-top: 1rem;
        font-weight: 500;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    // --- Utils for Base64URL ---
    function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let str = '';
        for (const char of bytes) {
            str += String.fromCharCode(char);
        }
        return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    function base64urlToBuffer(base64url) {
        const padding = '='.repeat((4 - base64url.length % 4) % 4);
        const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray.buffer;
    }

    // --- Experiment Logic ---

    async function updateStatus() {
        const res = await fetch('/exp7/status');
        const data = await res.json();
        const statusEl = document.getElementById('user-status');
        const setupSection = document.getElementById('setup-section');
        const logoutBtn = document.getElementById('logout-btn');

        if (data.user) {
            statusEl.textContent = 'Logged in as: ' + data.user;
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            setupSection.style.opacity = '1';
            setupSection.style.pointerEvents = 'auto';
            logoutBtn.style.display = 'block';
        } else {
            statusEl.textContent = 'Not Logged In';
            statusEl.style.background = '#eee';
            statusEl.style.color = 'black';
            setupSection.style.opacity = '0.5';
            setupSection.style.pointerEvents = 'none';
            logoutBtn.style.display = 'none';
        }
    }

    async function registerPassword() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const res = await fetch('/exp7/register_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: u, password: p })
        });
        const data = await res.json();
        document.getElementById('password-msg').innerText = data.message;
    }

    async function loginPassword() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const res = await fetch('/exp7/login_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: u, password: p })
        });
        const data = await res.json();
        document.getElementById('password-msg').innerText = data.message;
        updateStatus();
    }

    async function logout() {
        await fetch('/exp7/logout', { method: 'POST' });
        updateStatus();
        document.getElementById('setup-msg').innerText = '';
        document.getElementById('login-msg').innerText = '';
        document.getElementById('password-msg').innerText = 'Logged out.';
    }

    // --- WebAuthn ---

    async function registerWebAuthn() {
        const msg = document.getElementById('setup-msg');

        // CHECK: WebAuthn requires a domain, not an IP
        if (window.location.hostname === '127.0.0.1') {
            msg.innerText = "Error: WebAuthn does not work on 127.0.0.1. Please use 'localhost' in your URL instead.";
            msg.style.color = 'red';
            return;
        }

        msg.innerText = 'Starting WebAuthn registration...';

        try {
            // 1. Get options
            const res1 = await fetch('/exp7/webauthn/register/options', { method: 'POST' });
            const options = await res1.json();

            if (!options.success) {
                msg.innerText = 'Error: ' + options.message;
                return;
            }

            // Fix options for browser
            options.challenge = base64urlToBuffer(options.challenge);
            options.user.id = base64urlToBuffer(options.user.id);

            // 2. Create Credential
            const credential = await navigator.credentials.create({
                publicKey: options
            });

            // 3. Send to backend
            const credentialData = {
                id: credential.id,
                rawId: bufferToBase64url(credential.rawId),
                type: credential.type,
                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                attestationObject: bufferToBase64url(credential.response.attestationObject)
            };

            const res2 = await fetch('/exp7/webauthn/register/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentialData)
            });

            const result = await res2.json();
            msg.innerText = result.message;
            msg.style.color = result.success ? 'green' : 'red';

        } catch (e) {
            console.error(e);
            let errMsg = 'Detailed Error: ' + e.message;
            if (e.message.includes("domain")) {
                errMsg += " (Keep 'localhost' in your URL, do not use IP addresses)";
            }
            msg.innerText = errMsg;
            msg.style.color = 'red';
        }
    }

    async function loginWebAuthn() {
        const u = document.getElementById('login-username').value;
        const msg = document.getElementById('login-msg');

        // CHECK: WebAuthn requires a domain, not an IP
        if (window.location.hostname === '127.0.0.1') {
            msg.innerText = "Error: WebAuthn does not work on 127.0.0.1. Please use 'localhost' in your URL instead.";
            msg.style.color = 'red';
            return;
        }

        msg.innerText = 'Starting WebAuthn login...';

        try {
            // 1. Get options
            const res1 = await fetch('/exp7/webauthn/login/options', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u })
            });
            const options = await res1.json();

            if (!options.success) {
                msg.innerText = 'Error: ' + options.message;
                return;
            }

            // Fix options
            options.challenge = base64urlToBuffer(options.challenge);
            if (options.allowCredentials) {
                options.allowCredentials.forEach(c => {
                    c.id = base64urlToBuffer(c.id);
                });
            }

            // 2. Get Assertion
            const credential = await navigator.credentials.get({
                publicKey: options
            });

            // 3. Send to backend
            const credentialData = {
                username: u,
                id: credential.id,
                rawId: bufferToBase64url(credential.rawId),
                type: credential.type,
                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                authenticatorData: bufferToBase64url(credential.response.authenticatorData),
                signature: bufferToBase64url(credential.response.signature),
                userHandle: credential.response.userHandle ? bufferToBase64url(credential.response.userHandle) : null
            };

            const res2 = await fetch('/exp7/webauthn/login/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentialData)
            });

            const result = await res2.json();
            msg.innerText = result.message;
            msg.style.color = result.success ? 'green' : 'red';
            updateStatus();

        } catch (e) {
            console.error(e);
            msg.innerText = 'Error: ' + e.message;
        }
    }

    // Init
    updateStatus();

</script>
{% endblock %}